{"version":3,"sources":["../src/wall.js"],"names":["WallClient","host","port","path","clientId","generateClientId","client","Paho","MQTT","Client","connectOptions","onMessageArrived","message","onMessage","destinationName","payloadString","retained","onConnectionLost","error","console","info","onError","errorMessage","onSuccess","onConnected","onFailure","connect","currentTopic","$","noop","topic","fn","oldTopic","unsubscribe","subscribe","r","str","time","Date","now","rnd","Math","round","random","UI","setTitle","document","title","toast","type","persistent","text","addClass","hide","appendTo","fadeIn","delay","slideUp","queue","remove","find","click","location","reload","end","MessageLine","$parent","counter","init","$root","header","window","config","showCounter","$counterMark","$retainMark","$payload","stop","css","backgroundColor","animate","payload","isRetained","isSystemPayload","highlight","value","toggleClass","MessageContainer","reset","lines","html","undefined","update","Footer","className","removeClass","server","messages","footer","toString","state","load","description","isFatal","msg","val","hash","keypress","e","which","substr","defaultTopic"],"mappings":"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","file":"wall.js","sourcesContent":["// --- Application objects ----------------------------------------------------\r\n\r\nclass WallClient {\r\n\r\n    constructor(host, port, path) {\r\n        \r\n        this.clientId = WallClient.generateClientId();\r\n        \r\n        var client = new Paho.MQTT.Client(host, port, path, this.clientId);\r\n        var connectOptions = {};\r\n\r\n        client.onMessageArrived = (message) => {\r\n            //console.log(\"Message arrived \", message);\r\n            this.onMessage(message.destinationName, message.payloadString, message.retained);\r\n        };\r\n\r\n        client.onConnectionLost = (error) => {\r\n            console.info(\"Connection lost \", error);\r\n            this.onError(`Connection lost (${error.errorMessage})`, true);\r\n        };\r\n\r\n        connectOptions.onSuccess = () => {\r\n            console.info(\"Connect success\");\r\n            this.onConnected();\r\n        };\r\n\r\n        connectOptions.onFailure = (error) => {\r\n            console.error(\"Connect fail \", error);\r\n            this.onError(\"Fail to connect\", true);\r\n        };\r\n\r\n        client.connect(connectOptions);\r\n\r\n        this.client = client;\r\n        this.currentTopic = null;\r\n\r\n        this.onConnected = $.noop();\r\n        this.onMessage = $.noop();\r\n        this.onError = $.noop();\r\n    }\r\n\r\n    static generateClientId() {\r\n        var time = Date.now() % 1000;\r\n        var rnd = Math.round(Math.random() * 1000);\r\n        return `wall-${time*1000 + rnd}`;\r\n    }\r\n\r\n    subscribe (topic, fn) {\r\n    \r\n        // unsubscribe current topic (if exists)\r\n        if (this.currentTopic !== null) {\r\n            var oldTopic = this.currentTopic;\r\n            this.client.unsubscribe(oldTopic, {\r\n                onSuccess: () => {\r\n                    console.info(\"Unsubscribe '%s' success\", oldTopic);\r\n                },\r\n                onFailure: (error) => {\r\n                    console.error(\"Unsubscribe '%s' failure\", oldTopic, error);\r\n                }\r\n            });\r\n        }\r\n    \r\n        // subscribe new topic\r\n        this.client.subscribe(topic, {\r\n            onSuccess: (r) => {\r\n                console.info(\"Subscribe '%s' success\", topic, r);\r\n                fn();\r\n            },\r\n            onFailure: (r) => {\r\n                console.error(\"subscribe '%s' failure\", topic, r);\r\n                this.onError(\"Subscribe failure\");\r\n            }\r\n        });\r\n\r\n        this.currentTopic = topic;\r\n    }\r\n\r\n    toString () {\r\n        var str = this.client.host;\r\n\r\n        if (this.client.port != 80) {\r\n            str += \":\" + this.client.port;\r\n        }\r\n\r\n        if (this.client.path != \"\") {\r\n            str += \"\" + this.client.path;\r\n        } \r\n\r\n        return str;\r\n    }\r\n}\r\n\r\n// --- UI ---------------------------------------------------------------------\r\n\r\n\r\nvar UI = {};\r\n\r\nUI.setTitle = function (topic) {\r\n    document.title = \"MQTT Wall\" + (topic ? (\" for \" + topic) : \"\");\r\n};\r\n \r\nUI.toast = function (message, type = \"info\", persistent = false) {\r\n    var toast = $(\"<div class='toast-item'>\")\r\n        .text(message)\r\n        .addClass(type)\r\n        .hide()\r\n        .appendTo(\"#toast\")\r\n        .fadeIn();\r\n\r\n    if (persistent != true) {\r\n        toast.delay(5000).slideUp().queue(function () { this.remove(); });\r\n    } else {\r\n        $(\"<span> â€“ <a href='javascript:;'>reload</a></span>\")\r\n            .find(\"a\").click(function () { location.reload(); }).end()\r\n            .appendTo(toast);\r\n    }\r\n};\r\n\r\nclass MessageLine {\r\n\r\n    constructor(topic, $parent){\r\n        this.topic = topic;\r\n        this.counter = 0;\r\n        this.$parent = $parent;\r\n        this.init();\r\n    }\r\n\r\n    init() {\r\n        this.$root = $(\"<article class='message'>\");\r\n\r\n        var header = $(\"<header>\").appendTo(this.$root);\r\n\r\n        $(\"<h2>\")\r\n            .text(this.topic)\r\n            .appendTo(header);\r\n\r\n        if (window.config.showCounter) {\r\n            this.$counterMark = $(\"<span class='mark counter' title='Message counter'>0</span>\")\r\n                .appendTo(header);\r\n        }\r\n\r\n        this.$retainMark = $(\"<span class='mark retain' title='Retain message'>R</span>\")\r\n            .appendTo(header);\r\n\r\n        this.$payload = $(\"<p>\").appendTo(this.$root);\r\n        \r\n        this.$root.appendTo(this.$parent);\r\n    }\r\n\r\n    set isRetained(value) {\r\n        this.$retainMark[value ? 'show' : 'hide']();\r\n    }\r\n\r\n    set isSystemPayload(value) {\r\n        this.$payload.toggleClass(\"sys\", value);\r\n    }\r\n\r\n    highlight() {\r\n        this.$payload\r\n            .stop()\r\n            .css({backgroundColor: \"#0CB0FF\"})\r\n            .animate({backgroundColor: \"#fff\"}, 2000);\r\n    }\r\n\r\n    update(payload, retained) {\r\n        this.counter ++;\r\n        this.isRetained = retained;\r\n\r\n        if (this.$counterMark) {\r\n            this.$counterMark.text(this.counter)\r\n        }\r\n        \r\n        if (payload == \"\") \r\n        {\r\n            payload = \"NULL\";\r\n            this.isSystemPayload = true;\r\n        }\r\n        else\r\n        {\r\n            this.isSystemPayload = false;    \r\n        }\r\n\r\n        this.$payload.text(payload);\r\n        this.highlight();       \r\n    }\r\n}\r\n\r\nclass MessageContainer {\r\n    constructor($parent) {\r\n        this.$parent = $parent;\r\n        this.init();\r\n    }\r\n\r\n    init() {\r\n        this.reset();\r\n    }\r\n\r\n    reset() {\r\n        this.lines = {};\r\n        this.$parent.html(\"\");\r\n    }\r\n\r\n    update (topic, payload, retained) {\r\n\r\n        if (this.lines[topic] === undefined) {\r\n            this.lines[topic] = new MessageLine(topic, this.$parent);\r\n        }\r\n\r\n        this.lines[topic].update(payload, retained);\r\n    }\r\n}\r\n\r\nclass Footer {\r\n\r\n    set clientId(value) {\r\n        $(\"#status-client\").text(value);\r\n    }\r\n\r\n    set host(value) {\r\n        $(\"#status-host\").text(\"ws://\" + value);\r\n    }\r\n\r\n    set state(value) {\r\n        var className = [\"connecting\", \"connected\", \"fail\"];\r\n        var text = [\"connecting...\", \"connected\", \"not connected\"];\r\n\r\n        $(\"#status-state\").removeClass().addClass(className[value]);\r\n        $(\"#status-state span\").text(text[value]);\r\n    }\r\n}\r\n\r\n// --- Main -------------------------------------------------------------------\r\n\r\n\r\nvar client = new WallClient(config.server.host, config.server.port, config.server.path);\r\nvar messages = new MessageContainer($(\"section.messages\"));\r\nvar footer = new Footer();\r\n\r\nfooter.clientId = client.clientId;\r\nfooter.host = client.toString();\r\nfooter.state = 0;\r\n\r\nclient.onConnected = () => {\r\n    load();\r\n    footer.state = 1;\r\n    UI.toast(\"Connected to host \" + client.toString());\r\n};\r\n\r\nclient.onError = (description, isFatal) => {\r\n    UI.toast(description, \"error\", isFatal);\r\n\r\n    if (isFatal) footer.state = 2;\r\n};\r\n\r\nclient.onMessage = (topic, msg, retained) => {\r\n    messages.update(topic, msg, retained);\r\n};\r\n\r\nfunction load() {\r\n    var topic = $(\"#topic\").val();\r\n\r\n    client.subscribe(topic, function () {\r\n        UI.setTitle(topic);\r\n        location.hash = \"#\" + topic;\r\n    });\r\n\r\n    messages.reset();\r\n}\r\n\r\n$(\"#topic\").keypress(function(e) {\r\n    if(e.which == 13) {\r\n        load();\r\n    }\r\n});\r\n\r\n// URL hash \r\nif (location.hash != \"\") {\r\n    $(\"#topic\").val(location.hash.substr(1));\r\n} else {\r\n    $(\"#topic\").val(config.defaultTopic);\r\n}\r\n"]}